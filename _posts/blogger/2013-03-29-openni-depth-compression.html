---
title: "OpenNI + Depth & IR Compression + Pandaboard"
layout: "post"
permalink: "/2013/03/openni-depth-compression.html"
uuid: "3145342250221018346"
guid: "tag:blogger.com,1999:blog-4627720939429298175.post-3145342250221018346"
date: "2013-03-29 04:19:00"
updated: "2013-04-26 23:05:26"
description: 
blogger:
    siteid: "4627720939429298175"
    postid: "3145342250221018346"
    comments: "0"
categories: [development, kinect, raspberrypi]
author: 
    name: "Gremsi"
    url: "http://www.blogger.com/profile/00614962079213173450?rel=author"
    image: "http://img2.blogblog.com/img/b16-rounded.gif"
---

<div class="css-full-post-content js-full-post-content">
<div dir="ltr" style="text-align: left;" trbidi="on">[Update 4/14] I do not have access to a pandaboard yet, therefore I am working on this in Ubuntu with a Kinect.<br /><br />I am looking to compress depth images from a Kinect or Asus Xtion using OpenNI. Currently I am trying to modify NiViewer to capture and save depth frames as images.<br /><br />See <a href="https://groups.google.com/forum/?fromgroups=#!msg/openni-dev/iYtcrrA365U/wEFT2_-mH0wJ">https://groups.google.com/forum/?fromgroups=#!msg/openni-dev/iYtcrrA365U/wEFT2_-mH0wJ</a><br />I edited the files as listed on the google groups post.&nbsp;<span style="font-size: x-small;">Alternate link:&nbsp;</span><a href="http://gremsi.blogspot.com/2013/04/saving-rgb-and-depth-data-from-kinect.html" style="font-size: small;">http://gremsi.blogspot.com/2013/04/saving-rgb-and-depth-data-from-kinect.html</a><br /><br />Install OpenCV:&nbsp;<a href="http://mitchtech.net/raspberry-pi-opencv/">http://mitchtech.net/raspberry-pi-opencv/</a><br /><br />Edit the make file for NiViewer using this:&nbsp;<a href="http://ubuntuforums.org/showthread.php?t=1895678">http://ubuntuforums.org/showthread.php?t=1895678</a><br /><br />[Update 4/7]<br />I had a little trouble with the makefile for NiViewer using the link above. Here is what I have for &nbsp;OpenNI/Platform/Linux/Build/Samples/NiViewer/Makefile<br /><br /><br /><blockquote class="tr_bq">include ../../Common/CommonDefs.mak<br />BIN_DIR = ../../../Bin<br />INC_DIRS = \<br /><span class="Apple-tab-span" style="white-space: pre;"> </span>../../../../../Include \<br /><span class="Apple-tab-span" style="white-space: pre;"> </span>../../../../../Samples/NiViewer \<br /><span class="Apple-tab-span" style="white-space: pre;"> </span>/usr/local/lib \<br /><span class="Apple-tab-span" style="white-space: pre;"> </span>/usr/local/include/opencv<br />SRC_FILES = ../../../../../Samples/NiViewer/*.cpp<br />ifeq ("$(OSTYPE)","Darwin")<br /><span class="Apple-tab-span" style="white-space: pre;"> </span>LDFLAGS += -framework OpenGL -framework GLUT<br />else<br /><span class="Apple-tab-span" style="white-space: pre;"> </span>USED_LIBS += glut GL opencv_core opencv_highgui<br />endif<br />USED_LIBS += OpenNI<br />EXE_NAME = NiViewer<br />CFLAGS &nbsp; &nbsp; &nbsp; &nbsp;= -pipe -O2 -I/usr/local/include/opencv &nbsp;-D_REENTRANT $(DEFINES)<br />CXXFLAGS &nbsp; &nbsp; &nbsp;= -pipe -O2 -I/usr/local/include/opencv &nbsp;-D_REENTRANT $(DEFINES)<br />include ../../Common/CommonCppMakefile</blockquote><div><br /></div><br />[Update 4/14]<br />I ran NiViewer, right click and start capture.&nbsp;So as of now, it saves depth images (in OpenNI/Platform/Linux/Bin/(your platform)/CaptureFrames). Remember to create the CapturedFrames folder.<br /><br />Now, I want it to start capturing as soon as I ran the program so I edited the NiViewer.cpp file to this:<br /><br />Comment this part out in the main method (the part that handles the user interface):<br /><blockquote class="tr_bq"><span class="Apple-tab-span" style="white-space: pre;"> </span>reshaper.zNear = 1;<br /><span class="Apple-tab-span" style="white-space: pre;"> </span>reshaper.zFar = 100;<br /><span class="Apple-tab-span" style="white-space: pre;"> </span><br /><span class="Apple-tab-span" style="white-space: pre;"> </span>glut_add_interactor(&amp;reshaper);<br /><span class="Apple-tab-span" style="white-space: pre;"> </span>cb.mouse_function = MouseCallback;<br /><span class="Apple-tab-span" style="white-space: pre;"> </span>cb.motion_function = MotionCallback;<br /><span class="Apple-tab-span" style="white-space: pre;"> </span>cb.passive_motion_function = MotionCallback;<br /><span class="Apple-tab-span" style="white-space: pre;"> </span>cb.keyboard_function = KeyboardCallback;<br /><span class="Apple-tab-span" style="white-space: pre;"> </span>cb.reshape_function = ReshapeCallback;<br /><span class="Apple-tab-span" style="white-space: pre;"> </span>glut_add_interactor(&amp;cb);<br /><span class="Apple-tab-span" style="white-space: pre;"> </span>glutInit(&amp;argc, argv);<br /><span class="Apple-tab-span" style="white-space: pre;"> </span>glutInitDisplayString("stencil double rgb");<br /><span class="Apple-tab-span" style="white-space: pre;"> </span>glutInitWindowSize(WIN_SIZE_X, WIN_SIZE_Y);<br /><span class="Apple-tab-span" style="white-space: pre;"> </span>glutCreateWindow("OpenNI Viewer");<br /><span class="Apple-tab-span" style="white-space: pre;"> </span>glutFullScreen();<br /><span class="Apple-tab-span" style="white-space: pre;"> </span>glutSetCursor(GLUT_CURSOR_NONE);<br /><span class="Apple-tab-span" style="white-space: pre;"> </span>init_opengl();<br /><span class="Apple-tab-span" style="white-space: pre;"> </span>glut_helpers_initialize();<br /><span class="Apple-tab-span" style="white-space: pre;"> </span>glutIdleFunc(IdleCallback);<br /><span class="Apple-tab-span" style="white-space: pre;"> </span>glutDisplayFunc(drawFrame);<br /><span class="Apple-tab-span" style="white-space: pre;"> </span>drawInit();<br /><span class="Apple-tab-span" style="white-space: pre;"> </span>createKeyboardMap();<br /><span class="Apple-tab-span" style="white-space: pre;"> </span>createMenu();<br /><span class="Apple-tab-span" style="white-space: pre;"> </span>atexit(onExit);<br /><span class="Apple-tab-span" style="white-space: pre;"> </span>glutMainLoop();</blockquote>&nbsp;before the audioShutdown() command is called, I added these lines:<br /><br /><blockquote class="tr_bq">captureStart(0);<br />int i = 0;<br />while (i&lt;10)<br />{<br /><span class="Apple-tab-span" style="white-space: pre;"> </span>captureFrame();<br /><span class="Apple-tab-span" style="white-space: pre;"> </span>i++;<br />}<br /><span class="Apple-tab-span" style="white-space: pre;"> </span>captureStop(0);</blockquote>I compiled and ran NiViewer, but I was only getting blank images. This is because the saveFrame_depth() function (from the google groups post) is using a Linear Histogram. It seems that the calculateHistogram method needs to be called before the Linear Histogram is used. Before, drawFrame() was calling the calculateHistogram function and that is why it worked. I just wanted to see if this worked in general so inside the saveFrame_depth() function, there is a line that says switch(g_DrawConfig.Streams.Depth.Coloring), change this to switch(PSYCHEDELIC); Now I am able to see something in my saved depth image.<br /><br />[Update 4/17]<br />I wanted to see how much space it would take for depth data to be stored without any compression. I first started out writing the depth values to a binary file (in plain ascii). This is pretty simple but I am just writing everything out incase if anyone is confused. To do this, I created a new file in the beginning of the saveFrame_depth function:<br /><blockquote class="tr_bq">ofstream myfile;<br />myfile.open("depthData_ascii");</blockquote>Then inside the nested for loops (after the switch case statements), you will see data being assigned to red, blue and green pointers (e.g. Bptr[nX] = nBlue and etc). I added these lines under the red, green, blue pointer assignments:<br /><blockquote class="tr_bq">myfile &lt;&lt; *pDepth<br />myfile &lt;&lt; " ";&nbsp;</blockquote>The lines above should be inside the 2nd for loop. Then I added<br /><blockquote class="tr_bq">myfile &lt;&lt; "\n"&nbsp;</blockquote>at the end of the first for loop. So basically it should look like this:<br /><br /><blockquote class="tr_bq">saveFrame_depth(...)<br />{<br />&nbsp; &nbsp;ofstream myfile;<br />&nbsp; &nbsp;myfile.open("depthData_ascii");<br />&nbsp; &nbsp;//code<br />&nbsp; &nbsp;for(...)<br />&nbsp; &nbsp;{<br />&nbsp; &nbsp; &nbsp; for(...)<br />&nbsp; &nbsp; &nbsp; {<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;//code<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;myfile &lt;&lt; *pDepth<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;myfile &lt;&lt; " ";<br />&nbsp; &nbsp; &nbsp; }<br />&nbsp; &nbsp; &nbsp; myfile &lt;&lt; "\n"<br />&nbsp; &nbsp;}&nbsp;</blockquote><blockquote class="tr_bq">&nbsp; &nbsp;myfile.close()<br />&nbsp; &nbsp;//code&nbsp;</blockquote><blockquote class="tr_bq">}&nbsp;</blockquote><br />This file seems to take up around 1.2 mb of space per frame.<br /><br />[Update 4/21]<br />Saving it as a simple binary file seems to take up too much space. 1.2mb * 30fps * 60seconds/min * 60mins/hr is 126.562gb per hour. I tried to save the depth data inside a png as 16bit unsigned short integers. To do this, &nbsp;create a new matrix at the beginning of saveFrame_depth file. The dimensions of the matrix should be pDepthMD-&gt;YRes() by pDepthMD-&gt;XRes(). Instead of creating it as an 8bit unsigned, do 16bit unsigned (CV_16U). The code for this would look like:<br /><blockquote class="tr_bq">cv::Mat depthArray = cv::Mat(pDepthMD-&gt;YRes(), pDepthMD-&gt;XRes(), CV_16U)</blockquote>Inside the first for loop, there are RGB pointers being created with the colorArr variable. Create a pointer for for your depthArray in that same location.<br /><blockquote class="tr_bq"><strike>uchar* depthArrayPtr = depthArray.ptr&lt;uchar&gt;(nY);</strike>&nbsp;</blockquote><blockquote class="tr_bq">ushort* depthArrayPtr = depthArray.ptr&lt;ushort&gt;(nY);</blockquote><blockquote class="tr_bq">&nbsp;edit: I had to use ushort for the pointer type. Im not sure exactly why because the pointer type should stay the same length whether or not we are creating a depthArray of 16bit unsigned short or 8bit unsigned char. But using ushort works, where as if I used uchar it saved the image on the left half.</blockquote><br /><table><tbody><tr><td><table cellpadding="0" cellspacing="0" class="tr-caption-container" style="float: right; margin-left: 1em; text-align: right;"><tbody><tr><td style="text-align: center;"><a href="http://3.bp.blogspot.com/-FcZYOiHL3Cs/UXSkLw6gI2I/AAAAAAAAL-A/OGs88SzA_CY/s1600/image_depth_RAW_000000.png" imageanchor="1" style="clear: left; margin-bottom: 1em; margin-left: auto; margin-right: auto;"><img border="0" height="240" src="http://3.bp.blogspot.com/-FcZYOiHL3Cs/UXSkLw6gI2I/AAAAAAAAL-A/OGs88SzA_CY/s320/image_depth_RAW_000000.png" width="320" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">image when using uchar*</td></tr></tbody></table></td><td><table cellpadding="0" cellspacing="0" class="tr-caption-container" style="float: left; margin-right: 1em; text-align: left;"><tbody><tr><td style="text-align: center;"><a href="http://4.bp.blogspot.com/-mAOl_NnhVE4/UXSjblxC34I/AAAAAAAAL98/EvL9-hEPVbM/s1600/image_depth_RAW_000000.png" imageanchor="1" style="clear: right; margin-bottom: 1em; margin-left: auto; margin-right: auto;"><img border="0" height="240" src="http://4.bp.blogspot.com/-mAOl_NnhVE4/UXSjblxC34I/AAAAAAAAL98/EvL9-hEPVbM/s320/image_depth_RAW_000000.png" width="320" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">image when using &nbsp;ushort*</td></tr></tbody></table></td><td><br /></td></tr></tbody></table><br /><br />Inside the second for loop (toward the end of it), there are values being assigned to the locations of those pointers (e.g. Bptr[nX] = nBlue), under those lines, add this:<br /><blockquote class="tr_bq">depthArrayPtr[nX] = *pDepth</blockquote>All that is happening is, I am storing the raw depth value in an matrix. Save this array as a png image (add these lines at the end of the function saveFrame_depth):<br /><blockquote class="tr_bq">vector&lt;int&gt; compression_params;<br />compression_params.push_back(CV_IMWRITE_PNG_COMPRESSION);<br />compression_params.push_back(0);<br />imwrite(str_aux_raw, depthArray, compression_params);</blockquote>I had to <i>#include "cv.h", "highgui.h", &lt;vector&gt;, &lt;iostream&gt;, and &lt;fstream&gt;</i>. In addition to that, I added <i>using namespace std;</i> after my include statements.<br /><br />This will save the image as a png and it should have the original depth values. The total size comes out to be around 100kb - 200kb (depending on the depth image).<br /><br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://2.bp.blogspot.com/-mAOl_NnhVE4/UXSjblxC34I/AAAAAAAAL94/ysebPvBEqak/s1600/image_depth_RAW_000000.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="240" src="http://2.bp.blogspot.com/-mAOl_NnhVE4/UXSjblxC34I/AAAAAAAAL94/ysebPvBEqak/s320/image_depth_RAW_000000.png" width="320" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">124kb</td></tr></tbody></table><br /><br />To see if you are saving your png image correctly and the values are correct, I used MatLab. In MatLab enter this command:<br /><blockquote class="tr_bq">image = imread('/path/to/image.png'); imagesc(image); colorbar;</blockquote>This should give you a scale of the values represented in your depth image. You could even click Tools-&gt;Data Cursor (in the image window) and select a point in that image to get the specific value at that point.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-XIdb6tA9UUk/UXSjV_dZFeI/AAAAAAAAL9w/3Inbzzr_7Cc/s1600/Screen+Shot+2013-04-21+at+10.41.08+PM.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="280" src="http://4.bp.blogspot.com/-XIdb6tA9UUk/UXSjV_dZFeI/AAAAAAAAL9w/3Inbzzr_7Cc/s320/Screen+Shot+2013-04-21+at+10.41.08+PM.png" width="320" /></a></div><br />other information: ~1 min of recording depth as a png (with 0 compression) = &nbsp;14.5mb. It could be that it is not doing 30fps. There were over all of 117 images so thats about 2 images/frames per second.<br /><br />[Update 4/21]<br />I am now trying to get IR data and store it into the image. I found some code that could help:&nbsp;<a href="https://groups.google.com/d/msg/openni-dev/ytk-dRPDkoM/XKgoIhOxsv8J">https://groups.google.com/d/msg/openni-dev/ytk-dRPDkoM/XKgoIhOxsv8J</a><br /><br />[Update 4/26]<br />I dont think the code is the problem here, because viewing IR data is not working at all in NiViewer. However I do have some information about compression with depth data. I was able to use PNG_COMPRESSION in imwrite and set that value to 50. The image lowered about 10kb (so not that much). However if I had a binary/text file of 1.5mb and zipped that, it would go down to 67kb. So maybe I could use gzip to zip the files as I am saving them.<br /><br />Updating...</div>
</div>